---
mode: delegated
complexity: complex
type: enhancement
playwright: false
created: 2026-02-23T00:00:00
---

# Plan: Pro Tier Premium Features

## Task Description

Harden and complete the Pro tier implementation for `playwright-smart-reporter` (v1.0.8). The initial premium feature scaffold was built in a prior session — this plan fixes 8 audit issues, adds the missing PDF export, generates a real ES256 key pair with a CLI key generator, gates previously ungated features, and writes comprehensive tests for all new premium modules. Everything is fully local — no cloud, no additional infrastructure.

## Objective

Deliver a production-ready Pro tier that:
1. Validates license keys with a real ES256 key pair (offline, no network calls)
2. Gates all premium features (exports, themes, branding, AI model selection, notifications) behind license tiers
3. Exports PDF, JSON, and JUnit XML alongside the HTML report
4. Provides a CLI command to generate license keys for customers
5. Has test coverage for every new module (license, exporters, notifications, AI config, themes, branding)
6. Passes `tsc --noEmit` and the full test suite with zero failures

## Problem Statement

The prior session scaffolded premium types, license validation, exporters (JSON/JUnit), notifications, AI config, themes, and branding — but an audit found 8 issues:
1. **Placeholder public key** — no real license ever validates in production
2. **Theme/branding not gated** — any tier can use them (should require Pro)
3. **No PDF export** — `exportPdf` defined in types but unimplemented
4. **`stabilityGradeDrop` never evaluated** — notification condition is dead code
5. **`forcedLightPreset` invalid CSS** — dead code generating broken output
6. **High-contrast preset missing `data-theme`** — attribute not set on `<html>`
7. **AI tier gating is silent** — community users who set `ai.model` get downgraded with no console warning
8. **Zero tests** for all new premium modules (license, exporters, notifications, themes, branding, AI config)

## Solution Approach

Four workstreams executed in parallel where possible:

1. **License Infrastructure** — Generate a real ES256 key pair, embed the public key, create a `generate-license` CLI bin that signs JWTs with the private key. Add console warnings for silent degradation.
2. **Bug Fixes & Hardening** — Fix all 8 audit issues in existing premium code. Gate themes/branding behind Pro tier. Implement `stabilityGradeDrop`. Remove `forcedLightPreset` dead code. Set `data-theme` for high-contrast. Add AI config warning.
3. **PDF Export** — Implement `exportPdf` using Playwright's own chromium (peer dep) to render the HTML report to PDF. Zero new production dependencies.
4. **Tests** — Full test coverage for license validator, JSON exporter, JUnit exporter, notification manager, AI tier gating, theme/branding generation, and PDF export.

## Relevant Files

- `src/types.ts` — All premium type definitions (LicenseTier, LicenseInfo, ThemeConfig, BrandingConfig, NotificationConfig, AIConfig, SmartReporterOptions)
- `src/license/index.ts` — LicenseValidator class with placeholder public key
- `src/smart-reporter.ts` — Main reporter wiring (onEnd, constructor) — license validation, feature gating, export calls
- `src/generators/html-generator.ts` — Theme system (CSS variables, presets, high-contrast), branding (logo, title, footer), premium placeholders
- `src/generators/json-exporter.ts` — JSON data export
- `src/generators/junit-exporter.ts` — JUnit XML export
- `src/analyzers/ai-analyzer.ts` — AI model/prompt config with tier gating
- `src/notifiers/notification-manager.ts` — Multi-channel notification dispatcher with conditions and templates
- `src/notifiers/pagerduty-notifier.ts` — PagerDuty integration
- `src/notifiers/email-notifier.ts` — SendGrid email integration
- `src/notifiers/custom-webhook-notifier.ts` — Custom webhook notifier
- `src/collectors/history-collector.ts` — History collector (updated for premium option pass-through)
- `example/playwright-premium.config.ts` — Demo config with dev JWT

### New Files

- `src/generators/pdf-exporter.ts` — PDF export using Playwright chromium render-to-PDF
- `src/license/generate-license.ts` — CLI script for signing license key JWTs
- `src/license/license-validator.test.ts` — License validator tests
- `src/generators/json-exporter.test.ts` — JSON exporter tests
- `src/generators/junit-exporter.test.ts` — JUnit exporter tests
- `src/generators/pdf-exporter.test.ts` — PDF exporter tests
- `src/notifiers/notification-manager.test.ts` — Notification manager tests
- `src/analyzers/ai-analyzer-config.test.ts` — AI tier gating and config tests
- `src/generators/theme-branding.test.ts` — Theme and branding generation tests

## Implementation Phases

### Phase 1: Foundation
Research existing code patterns (test structure, build config), generate ES256 key pair, fix license validator with real public key, create CLI key generator.

### Phase 2: Core Implementation
Fix all 8 audit issues across html-generator, smart-reporter, ai-analyzer, and notification-manager. Implement PDF export. Gate themes/branding.

### Phase 3: Integration & Polish
Write comprehensive tests for all premium modules. Integration tests for the full export pipeline. Final review and validation.

## Team Members

- License Builder
  - **Role**: ES256 key pair generation, license validator hardening, CLI key generator
  - **Agent Type**: builder

- Bug Fix Builder
  - **Role**: Fix 8 audit issues (theme/branding gating, dead code, missing attributes, AI warnings, stabilityGradeDrop)
  - **Agent Type**: builder

- PDF Builder
  - **Role**: Implement PDF export using Playwright chromium render-to-PDF
  - **Agent Type**: builder

- Test Builder
  - **Role**: Write tests for license, exporters, notifications, AI config, themes, branding
  - **Agent Type**: builder

- Integration Tester
  - **Role**: Adversarial and integration tests across premium modules (license + gating + export pipeline)
  - **Agent Type**: tester

- Code Reviewer
  - **Role**: Review all code changes for correctness, security, edge cases, and spec compliance
  - **Agent Type**: reviewer

- Final Validator
  - **Role**: Run all validation commands, verify every acceptance criterion
  - **Agent Type**: validator

## Review Policy

- **Review After**: each task
- **Fix Loop Trigger**: Critical and Important
- **Max Retries**: 3
- **Skip Review For**: research-codebase, review-all, validate-all

## Step by Step Tasks

### 1. Research Codebase Patterns
- **Task ID**: research-codebase
- **Depends On**: none
- **Description**:
  - Read all existing test files to understand testing patterns (vitest/jest, mocking approach, file structure)
  - Read `package.json` for test runner config, build scripts, and bin entries
  - Read `tsconfig.json` for compilation targets
  - Read `src/smart-reporter.ts` lines related to license validation and feature gating
  - Read `src/generators/html-generator.ts` theme and branding sections
  - Document: test runner, assertion library, mock patterns, build tool, existing bin scripts
- **Tests**: N/A
- **Assigned To**: Researcher
- **Agent Type**: researcher
- **Background**: true

### 2. Build License Infrastructure
- **Task ID**: build-license
- **Depends On**: research-codebase
- **Description**:
  - Generate a real ES256 (ECDSA P-256) key pair using Node.js crypto
  - Save private key to `keys/private.pem` (gitignored) and public key to `keys/public.pem`
  - Replace the placeholder public key in `src/license/index.ts` with the real one
  - Create `src/license/generate-license.ts` — a CLI script that:
    - Accepts `--tier pro|team`, `--org "Org Name"`, `--expiry 2027-01-01` (optional, defaults to 1 year)
    - Reads `keys/private.pem`
    - Signs a JWT with ES256 containing `{ tier, org, exp, iat }`
    - Outputs the license key string to stdout
  - Add a `bin` entry in `package.json`: `"generate-license": "./dist/license/generate-license.js"`
  - Add `keys/` to `.gitignore` (keep `keys/public.pem` tracked if desired, but private key must be gitignored)
  - Verify: generate a key, validate it with `LicenseValidator` — confirm tier is `pro`
- **Tests**:
  - `src/license/license-validator.test.ts`:
    - No key returns community tier with valid=true
    - Valid Pro JWT returns pro tier
    - Valid Team JWT returns team tier
    - Expired JWT returns community with error
    - Malformed token returns community with error
    - Invalid signature returns community with error
    - `hasFeature` returns correct booleans for community/pro/team combinations
    - Dev mode bypass works with unsigned token
    - Environment variable `SMART_REPORTER_LICENSE_KEY` is read when no key arg passed
- **Assigned To**: License Builder
- **Agent Type**: builder
- **Background**: false

### 3. Review License Infrastructure
- **Task ID**: review-license
- **Depends On**: build-license
- **Description**: Review license validator changes, key generator CLI, and tests. Verify: no private key in tracked files, JWT claims are correct, tier validation is exhaustive, test coverage is complete.
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 4. Fix Audit Issues
- **Task ID**: fix-audit-issues
- **Depends On**: research-codebase
- **Description**:
  - **Theme/branding gating** (`src/smart-reporter.ts`): Gate `theme` and `branding` options behind Pro tier using `LicenseValidator.hasFeature()`. If community tier, ignore theme/branding config and log a warning.
  - **`stabilityGradeDrop` condition** (`src/notifiers/notification-manager.ts`): Implement the `stabilityGradeDrop` condition. It should compare the current run's average stability grade against the previous run. Requires accepting `comparison` data as a parameter to `notify()` or `evaluateConditions()`.
  - **`forcedLightPreset` dead code** (`src/generators/html-generator.ts`): Find and remove the `forcedLightPreset` code path that generates invalid CSS. If it serves a purpose, fix it; if dead, delete it.
  - **High-contrast `data-theme`** (`src/generators/html-generator.ts`): When `theme.preset === 'high-contrast'`, set `data-theme="high-contrast"` on the `<html>` tag, matching how `dark`/`light` presets work.
  - **AI silent degradation** (`src/analyzers/ai-analyzer.ts`): When a community-tier user configures `ai.model` and it gets downgraded to the free default, log `console.warn()` explaining that model selection requires a Pro license.
  - **Duplicate CSS variable mapping** (`src/generators/html-generator.ts`): Fix `primary` and `success` theme colors mapping to the same CSS variable. Ensure each ThemeConfig field maps to a distinct CSS custom property.
  - **Reporter version hardcoded** (`src/generators/json-exporter.ts`): Read version from `package.json` instead of hardcoding `'1.0.8'`.
  - **JUnit timestamp attribute** (`src/generators/junit-exporter.ts`): Add `timestamp` attribute to `<testsuite>` elements (ISO 8601 format).
- **Tests**:
  - `src/generators/theme-branding.test.ts`:
    - Theme preset generates correct CSS variables
    - Custom theme colors override defaults
    - High-contrast preset sets `data-theme="high-contrast"`
    - `forcedLightPreset` code path is removed or fixed
    - Branding config renders logo, custom title, custom footer
    - `hidePoweredBy` suppresses attribution
  - `src/analyzers/ai-analyzer-config.test.ts`:
    - Community tier with custom model gets downgraded to default with warning
    - Pro tier with custom model uses it directly
    - Custom system prompt is passed through
    - Custom prompt template interpolates variables
    - Custom maxTokens is respected
  - `src/notifiers/notification-manager.test.ts`:
    - Conditions: minFailures, maxPassRate, tags filtering
    - stabilityGradeDrop evaluates correctly (grade improved = no notify, grade dropped = notify)
    - Template rendering with all variables
    - Channel dispatch (mock each notifier constructor)
    - Error handling (failed notifier doesn't crash others)
- **Assigned To**: Bug Fix Builder
- **Agent Type**: builder
- **Background**: false

### 5. Review Audit Fixes
- **Task ID**: review-audit-fixes
- **Depends On**: fix-audit-issues
- **Description**: Review all 8 audit fixes. Verify: theme/branding correctly gated, stabilityGradeDrop works, dead code removed, high-contrast data-theme set, AI warning logged, CSS vars are distinct, version dynamic, JUnit timestamps present. Check tests cover each fix.
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 6. Implement PDF Export
- **Task ID**: build-pdf-export
- **Depends On**: research-codebase
- **Description**:
  - Create `src/generators/pdf-exporter.ts` with function `exportPdfReport(htmlPath: string, options: SmartReporterOptions, outputDir?: string): Promise<string>`
  - Use Playwright's chromium (already a peer dep) to:
    - Launch headless chromium via `playwright-core` (dynamically imported to avoid hard dep)
    - Navigate to the HTML report file (`file://` protocol)
    - Wait for page to fully render (network idle or explicit wait)
    - Call `page.pdf()` with A4 landscape, print background enabled
    - Save to `smart-report.pdf` in the same directory as the HTML report
    - Close browser
  - Handle missing Playwright gracefully — if `playwright-core` is not installed, log a warning and skip PDF generation (don't crash the reporter)
  - Wire into `src/smart-reporter.ts` `onEnd()`:
    - After HTML report is written, if `exportPdf: true` and tier is Pro, call `exportPdfReport()`
    - Add PDF to the premium placeholder section in HTML (update the greyed-out placeholder to show as active when licensed)
  - Return the output path
- **Tests**:
  - `src/generators/pdf-exporter.test.ts`:
    - Generates PDF file at expected path when Playwright is available
    - Returns correct output path
    - Handles missing Playwright gracefully (logs warning, returns undefined/null)
    - Handles invalid HTML path (file not found)
    - Respects outputDir parameter
    - PDF file is non-empty and starts with `%PDF` magic bytes
- **Assigned To**: PDF Builder
- **Agent Type**: builder
- **Background**: true

### 7. Review PDF Export
- **Task ID**: review-pdf-export
- **Depends On**: build-pdf-export
- **Description**: Review PDF exporter implementation. Verify: dynamic import of playwright-core, graceful fallback, proper browser cleanup (finally block), file path handling, test coverage.
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 8. Write Exporter Tests
- **Task ID**: build-exporter-tests
- **Depends On**: fix-audit-issues, build-license
- **Description**:
  - Create `src/generators/json-exporter.test.ts`:
    - Produces valid JSON file at expected path
    - Summary fields are correct (total, passed, failed, skipped, flaky, passRate)
    - Stability grade calculation (average across tests)
    - Tests array contains all required fields (testId, title, file, status, duration, retry)
    - Failure clusters are included when present
    - Comparison data is included when present
    - History data is included
    - Handles empty results array
    - Handles results with no stability scores
    - Version comes from package.json (not hardcoded)
    - outputDir parameter is respected
  - Create `src/generators/junit-exporter.test.ts`:
    - Produces valid XML file at expected path
    - Root `<testsuites>` has correct aggregate counts
    - Tests grouped by spec file into `<testsuite>` elements
    - Each `<testsuite>` has `timestamp` attribute
    - Failed tests have `<failure>` with type, message, and body
    - Skipped tests have `<skipped />`
    - Interrupted tests have `<error>`
    - Custom properties (stability-grade, flakiness-score, performance-trend, tags, retries, outcome) present
    - XML is well-formed (no unescaped characters)
    - outputDir parameter is respected
- **Tests**: Tests are the deliverable for this task (see description above)
- **Assigned To**: Test Builder
- **Agent Type**: builder
- **Background**: true

### 9. Review Exporter Tests
- **Task ID**: review-exporter-tests
- **Depends On**: build-exporter-tests
- **Description**: Review JSON and JUnit exporter tests. Verify: edge cases covered, no tests that only test mocks, assertions are meaningful, test isolation (cleanup temp files).
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 10. Integration & Adversarial Testing
- **Task ID**: integration-tests
- **Depends On**: build-license, fix-audit-issues, build-pdf-export, build-exporter-tests
- **Description**:
  - Write integration tests that verify the full premium pipeline end-to-end:
    - Community tier: confirm JSON/JUnit/PDF exports are skipped, theme/branding ignored, AI uses default model
    - Pro tier: confirm JSON/JUnit/PDF exports are produced, theme CSS vars injected, branding rendered, AI uses custom model
    - Team tier: confirm all Pro features work plus team-only features
  - Write adversarial tests for license validator:
    - Tampered JWT payload (change tier after signing)
    - JWT with missing fields (no tier, no exp)
    - JWT with future iat but past exp
    - Empty string key, whitespace-only key
    - Very long token string
  - Write boundary tests for notification conditions:
    - Exactly at minFailures threshold (boundary)
    - Exactly at maxPassRate threshold (boundary)
    - Empty results array
    - All tests skipped (0 pass rate, 0 failures)
- **Tests**: Tests are the deliverable for this task
- **Assigned To**: Integration Tester
- **Agent Type**: tester
- **Background**: false

### 11. Review Integration Tests
- **Task ID**: review-integration-tests
- **Depends On**: integration-tests
- **Description**: Review integration and adversarial tests. Verify: tests cover the full pipeline, adversarial inputs are realistic, boundary tests are correct, no false positives.
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 12. Code Review
- **Task ID**: review-all
- **Depends On**: build-license, fix-audit-issues, build-pdf-export, build-exporter-tests, integration-tests
- **Description**: Final comprehensive review of all code changes. Check for: correctness, security (no private keys in source, no hardcoded secrets), edge cases, style consistency with existing codebase, test quality, spec compliance. Report issues by severity (Critical, Important, Minor).
- **Assigned To**: Code Reviewer
- **Agent Type**: reviewer
- **Background**: false

### 13. Final Validation
- **Task ID**: validate-all
- **Depends On**: review-all
- **Description**: Run all validation commands, verify every acceptance criterion is met.
- **Assigned To**: Final Validator
- **Agent Type**: validator
- **Background**: false

## Documentation Requirements

- Inline comments on `generate-license.ts` CLI usage (--help output)
- JSDoc on `exportPdfReport()` explaining Playwright dependency and graceful fallback
- Update `example/playwright-premium.config.ts` to demonstrate `exportPdf: true` option
- No README changes unless user requests them

## Acceptance Criteria

1. `tsc --noEmit` passes with zero errors
2. Full test suite passes (`npx vitest run` or project's test command) with zero failures
3. A real ES256 key pair exists and `LicenseValidator` validates keys signed with it
4. `generate-license` CLI produces valid Pro and Team license keys
5. Community tier: JSON/JUnit/PDF exports are skipped; theme/branding config is ignored with warning
6. Pro tier: JSON, JUnit, and PDF files are generated alongside HTML report
7. PDF export handles missing Playwright gracefully (warning, no crash)
8. All 8 audit issues are fixed (verified individually)
9. `stabilityGradeDrop` notification condition evaluates correctly
10. AI model downgrade logs a console warning for community tier
11. High-contrast theme sets `data-theme="high-contrast"` on `<html>`
12. Reporter version in JSON export is read from package.json
13. JUnit `<testsuite>` elements have `timestamp` attribute
14. No private keys committed to git (keys/ directory is gitignored)
15. All new modules have test coverage (license, JSON exporter, JUnit exporter, PDF exporter, notification manager, AI config, theme/branding)

## Validation Commands

```bash
# TypeScript compilation
npx tsc --noEmit

# Full test suite
npx vitest run

# Verify no private keys in tracked files
git ls-files | grep -i private && echo "FAIL: private key tracked" || echo "PASS"

# Verify keys directory is gitignored
grep -q "keys/" .gitignore && echo "PASS" || echo "FAIL: keys/ not in .gitignore"

# Generate a license key and validate it
node dist/license/generate-license.js --tier pro --org "Test Corp" | head -1

# Build check
npm run build
```

## Notes

- Playwright is a peer dependency — PDF export must handle its absence gracefully via dynamic import
- The `SMART_REPORTER_DEV_LICENSE=true` env var bypass should remain for development/testing
- The private key is a build-time/admin tool only — never shipped in the npm package
- All existing free features remain completely unchanged and ungated
- The reporter version string `'1.0.8'` appears in json-exporter.ts and should be replaced with a dynamic read from package.json (or the version export from the package)
